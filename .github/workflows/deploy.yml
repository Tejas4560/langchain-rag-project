name: Deploy to Cloud Run

on:
  push:
    branches:
      - main

jobs:
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        run: |-
          CLEAN_PROJECT_ID=$(echo "${{ secrets.GCP_PROJECT_ID }}" | tr -d '\n' | tr -d '\r')
          echo "PROJECT_ID=$CLEAN_PROJECT_ID" >> $GITHUB_ENV
          echo "IMAGE_BACKEND=gcr.io/$CLEAN_PROJECT_ID/rag-backend" >> $GITHUB_ENV

      - id: 'auth'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - run: |-
          gcloud --quiet auth configure-docker

      # Setup Docker Buildx for Caching
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ env.IMAGE_BACKEND }}:${{ github.sha }},${{ env.IMAGE_BACKEND }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        run: |-
          CLEAN_PROJECT_ID=$(echo "${{ secrets.GCP_PROJECT_ID }}" | tr -d '\n' | tr -d '\r')
          echo "PROJECT_ID=$CLEAN_PROJECT_ID" >> $GITHUB_ENV
          echo "IMAGE_FRONTEND=gcr.io/$CLEAN_PROJECT_ID/rag-frontend" >> $GITHUB_ENV

      - id: 'auth'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - run: |-
          gcloud --quiet auth configure-docker

      # Setup Docker Buildx for Caching
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Frontend
        run: |-
          cd frontend
          npm install
          npm run build
          # We manually build frontend because we need the 'build' directory from above
          # Docker caching is less critical for frontend (npm install is fast-ish), but we can still use it for the docker build part if we wanted.
          # For simplicity and given the npm build happened locally in runner, sticking to standard build is safer unless we do multi-stage build.
          # However, let's stick to standard docker build for frontend to avoid context complexity with 'build' dir.
          docker build \
            --tag "$IMAGE_FRONTEND:$GITHUB_SHA" \
            --tag "$IMAGE_FRONTEND:latest" \
            .
          docker push "$IMAGE_FRONTEND:$GITHUB_SHA"
          docker push "$IMAGE_FRONTEND:latest"

  deploy:
    name: Deploy Services
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    env:
      REGION: ${{ secrets.GCP_REGION }}
      SERVICE_BACKEND: rag-backend
      SERVICE_FRONTEND: rag-frontend
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        run: |-
          CLEAN_PROJECT_ID=$(echo "${{ secrets.GCP_PROJECT_ID }}" | tr -d '\n' | tr -d '\r')
          echo "PROJECT_ID=$CLEAN_PROJECT_ID" >> $GITHUB_ENV
          echo "IMAGE_BACKEND=gcr.io/$CLEAN_PROJECT_ID/rag-backend" >> $GITHUB_ENV
          echo "IMAGE_FRONTEND=gcr.io/$CLEAN_PROJECT_ID/rag-frontend" >> $GITHUB_ENV

      - id: 'auth'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      # Deploy Backend (Initial)
      - name: Deploy Backend to Cloud Run
        id: deploy-backend
        uses: google-github-actions/deploy-cloudrun@v1
        with:
          service: ${{ env.SERVICE_BACKEND }}
          image: ${{ env.IMAGE_BACKEND }}:${{ github.sha }}
          region: ${{ env.REGION }}
          env_vars: |
            GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            GROQ_MODEL=llama3-8b-8192
          flags: '--allow-unauthenticated --memory=1Gi'

      # Deploy Frontend (With Backend URL)
      - name: Deploy Frontend to Cloud Run
        id: deploy-frontend
        uses: google-github-actions/deploy-cloudrun@v1
        with:
          service: ${{ env.SERVICE_FRONTEND }}
          image: ${{ env.IMAGE_FRONTEND }}:${{ github.sha }}
          region: ${{ env.REGION }}
          env_vars: |
            BACKEND_URL=${{ steps.deploy-backend.outputs.url }}
          flags: '--allow-unauthenticated'

      # Update Backend (With Self URL and Frontend URL)
      - name: Configure Backend URLs
        run: |-
          gcloud run deploy ${{ env.SERVICE_BACKEND }} \
            --image ${{ env.IMAGE_BACKEND }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --update-env-vars BASE_URL=${{ steps.deploy-backend.outputs.url }},FRONTEND_URL=${{ steps.deploy-frontend.outputs.url }}

      - name: Show Output
        run: |-
          echo "Backend URL: ${{ steps.deploy-backend.outputs.url }}"
          echo "Frontend URL: ${{ steps.deploy-frontend.outputs.url }}"
